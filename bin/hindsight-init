#!/bin/bash
# hindsight-init - Initialize Hindsight MCP Server
#
# This script sets up the Hindsight runtime environment and optionally
# configures Claude Desktop/Code to use the MCP server.
#
# Copyright (c) 2025 FOS Computer Services, LLC
# Licensed under the MIT License

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Hindsight directories
HINDSIGHT_DIR="$HOME/.hindsight"
LOGS_DIR="$HINDSIGHT_DIR/logs"
BACKUPS_DIR="$HINDSIGHT_DIR/backups"

# Determine installation source (Homebrew or local)
if command -v brew &> /dev/null && [ -d "$(brew --prefix)/opt/hindsight-mcp" ]; then
    INSTALL_PREFIX="$(brew --prefix)/opt/hindsight-mcp"
    SCHEMA_PATH="$INSTALL_PREFIX/libexec/schema.sql"
    CONFIG_PATH="$INSTALL_PREFIX/etc/hindsight/config.json"
    PYTHON_PATH="$INSTALL_PREFIX/libexec/bin/python3"
    SERVER_PATH="$INSTALL_PREFIX/libexec/server.py"
else
    # Fallback to script directory (for development/manual install)
    SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
    SCHEMA_PATH="$SCRIPT_DIR/schema.sql"
    CONFIG_PATH="$SCRIPT_DIR/config.json"
    PYTHON_PATH="$HINDSIGHT_DIR/.venv/bin/python3"
    SERVER_PATH="$HINDSIGHT_DIR/server.py"
fi

# Claude config paths
CLAUDE_DESKTOP_CONFIG="$HOME/Library/Application Support/Claude/claude_desktop_config.json"
CLAUDE_CODE_CONFIG="$HOME/.claude/settings.json"

print_status() {
    echo -e "${BLUE}==>${NC} $1"
}

print_success() {
    echo -e "${GREEN}==>${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}Warning:${NC} $1"
}

print_error() {
    echo -e "${RED}Error:${NC} $1"
}

# Create directory structure
create_directories() {
    print_status "Creating directory structure..."

    mkdir -p "$HINDSIGHT_DIR"
    mkdir -p "$LOGS_DIR"
    mkdir -p "$BACKUPS_DIR"

    print_success "Created $HINDSIGHT_DIR"
}

# Copy default config if not exists
setup_config() {
    if [ ! -f "$HINDSIGHT_DIR/config.json" ]; then
        if [ -f "$CONFIG_PATH" ]; then
            print_status "Copying default configuration..."
            cp "$CONFIG_PATH" "$HINDSIGHT_DIR/config.json"
            print_success "Created $HINDSIGHT_DIR/config.json"
        else
            print_warning "Default config not found at $CONFIG_PATH"
        fi
    else
        print_status "Configuration already exists, preserving..."
    fi
}

# Initialize database
init_database() {
    if [ ! -f "$HINDSIGHT_DIR/knowledge.db" ]; then
        if [ -f "$SCHEMA_PATH" ]; then
            print_status "Initializing database..."
            sqlite3 "$HINDSIGHT_DIR/knowledge.db" < "$SCHEMA_PATH"
            print_success "Created $HINDSIGHT_DIR/knowledge.db"
        else
            print_error "Schema file not found at $SCHEMA_PATH"
            exit 1
        fi
    else
        print_status "Database already exists, preserving..."
    fi
}

# Add hindsight to JSON config file
add_to_mcp_config() {
    local config_file="$1"
    local config_name="$2"

    if [ ! -f "$config_file" ]; then
        return 1
    fi

    # Check if hindsight is already configured
    if grep -q '"hindsight"' "$config_file" 2>/dev/null; then
        print_status "$config_name already has hindsight configured"
        return 0
    fi

    print_status "Configuring $config_name..."

    # Create Python script to safely modify JSON
    python3 << EOF
import json
import sys
from pathlib import Path

config_file = Path("""$config_file""")
python_path = """$PYTHON_PATH"""
server_path = """$SERVER_PATH"""

try:
    with open(config_file, 'r') as f:
        config = json.load(f)
except json.JSONDecodeError:
    print("Invalid JSON in config file", file=sys.stderr)
    sys.exit(1)

# Ensure mcpServers exists
if 'mcpServers' not in config:
    config['mcpServers'] = {}

# Add hindsight configuration
config['mcpServers']['hindsight'] = {
    'command': python_path,
    'args': [server_path]
}

# Write back with nice formatting
with open(config_file, 'w') as f:
    json.dump(config, f, indent=2)

print("Successfully configured")
EOF

    if [ $? -eq 0 ]; then
        print_success "Added hindsight to $config_name"
        return 0
    else
        print_warning "Could not configure $config_name"
        return 1
    fi
}

# Configure Claude Desktop
configure_claude_desktop() {
    if [ -f "$CLAUDE_DESKTOP_CONFIG" ]; then
        add_to_mcp_config "$CLAUDE_DESKTOP_CONFIG" "Claude Desktop"
    else
        print_status "Claude Desktop config not found (this is OK if not installed)"
    fi
}

# Configure Claude Code
configure_claude_code() {
    # Create .claude directory if it doesn't exist
    mkdir -p "$HOME/.claude"

    if [ -f "$CLAUDE_CODE_CONFIG" ]; then
        add_to_mcp_config "$CLAUDE_CODE_CONFIG" "Claude Code"
    else
        # Create new settings.json with hindsight config
        print_status "Creating Claude Code configuration..."
        cat > "$CLAUDE_CODE_CONFIG" << EOF
{
  "mcpServers": {
    "hindsight": {
      "command": "$PYTHON_PATH",
      "args": ["$SERVER_PATH"]
    }
  }
}
EOF
        print_success "Created $CLAUDE_CODE_CONFIG"
    fi
}

# Print summary
print_summary() {
    echo ""
    echo -e "${GREEN}========================================${NC}"
    echo -e "${GREEN}Hindsight MCP Server initialized!${NC}"
    echo -e "${GREEN}========================================${NC}"
    echo ""
    echo "Runtime directory: $HINDSIGHT_DIR"
    echo "Database: $HINDSIGHT_DIR/knowledge.db"
    echo "Logs: $LOGS_DIR"
    echo "Backups: $BACKUPS_DIR"
    echo ""

    if [ -f "$CLAUDE_DESKTOP_CONFIG" ] && grep -q '"hindsight"' "$CLAUDE_DESKTOP_CONFIG" 2>/dev/null; then
        echo -e "${GREEN}Claude Desktop:${NC} Configured"
        echo "  Restart Claude Desktop to activate"
    fi

    if [ -f "$CLAUDE_CODE_CONFIG" ] && grep -q '"hindsight"' "$CLAUDE_CODE_CONFIG" 2>/dev/null; then
        echo -e "${GREEN}Claude Code:${NC} Configured"
        echo "  Run 'claude mcp list' to verify"
    fi

    echo ""
    echo "To verify installation:"
    echo "  claude mcp list           # Should show 'hindsight'"
    echo ""
    echo "To load sample data:"
    echo "  sqlite3 ~/.hindsight/knowledge.db < test-data.sql"
    echo ""
}

# Parse command line arguments
SKIP_CLAUDE_CONFIG=false
FORCE=false

while [[ $# -gt 0 ]]; do
    case $1 in
        --skip-claude-config)
            SKIP_CLAUDE_CONFIG=true
            shift
            ;;
        --force)
            FORCE=true
            shift
            ;;
        --help|-h)
            echo "Usage: hindsight-init [OPTIONS]"
            echo ""
            echo "Initialize Hindsight MCP Server runtime environment."
            echo ""
            echo "Options:"
            echo "  --skip-claude-config  Don't configure Claude Desktop/Code"
            echo "  --force              Reinitialize even if already set up"
            echo "  --help, -h           Show this help message"
            exit 0
            ;;
        *)
            print_error "Unknown option: $1"
            exit 1
            ;;
    esac
done

# Main execution
main() {
    echo ""
    echo -e "${BLUE}Hindsight MCP Server Initialization${NC}"
    echo ""

    create_directories
    setup_config
    init_database

    if [ "$SKIP_CLAUDE_CONFIG" = false ]; then
        configure_claude_desktop
        configure_claude_code
    fi

    print_summary
}

main
